ImageStore:
  description: >
    Store and retrieve images in PostgreSQL with BYTEA payload and a SHA-256
    content hash as the primary key. Payload is immutable; filename may refresh
    on upsert. Includes strict validation and guardrails.
  fields:
    dsn_or_conn:
      type: string | psycopg.Connection
      description: PostgreSQL DSN string or an existing psycopg v3 connection
    _conn:
      type: psycopg.Connection
      description: Internal connection (autocommit enabled)
    _owns_conn:
      type: boolean
      description: Whether this instance owns the connection lifecycle
    max_bytes:
      type: integer
      default: 52428800
      description: Max allowed file size in bytes (50 MB by default)
  exceptions:
    ImageStoreError:
      description: Generic failure (DB, IO, validation)
  methods:
    __post_init__:
      description: Initialize connection, set autocommit, and ensure schema/indexes/constraints
    _ensure_schema:
      description: Create/verify table, filename index, and sha256 CHECK constraint
    _read_file_bytes:
      args: [path: string, max_bytes: integer]
      returns: bytes
      description: Read file bytes from disk with size guard and existence check
    _sha256:
      args: [data: bytes]
      returns: string
      description: Compute lowercase hex SHA-256 of raw bytes
    _to_bytes:
      args: [db_value: any]
      returns: bytes
      description: Normalize psycopg BYTEA result (e.g., memoryview) to bytes
    _validate_sha:
      args: [sha256: string]
      returns: void
      description: Validate 64-char lowercase hex digest; raise on invalid
    add_image:
      args: [file_path: string]
      returns: sha256: string
      description: >
        Read file, compute SHA-256, insert (sha256, filename, BYTEA) with upsert
        on sha256 that refreshes filename but keeps original payload.
    get_image_bytes:
      args: [sha256: string]
      returns: bytes | null
      description: Fetch raw bytes by SHA-256 or null if not found
    write_image_to:
      args: [sha256: string, out_path: string]
      returns: boolean
      description: Write fetched bytes to disk; returns false if not found
    get_latest_by_filename_bytes:
      args: [img_filename: string]
      returns: bytes | null
      description: Fetch newest (by created_at DESC) entry for a filename
    list_shas_for_filename:
      args: [img_filename: string]
      returns: iterable<(sha256: string, created_at_iso: string)>
      description: Enumerate all hashes for a filename, newest first
    close:
      description: Close owned connection (no-op if external)
